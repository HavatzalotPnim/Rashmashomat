<head>
<title>רשמ"שומט</title>
<link rel="icon" href="https://i.imgur.com/wvNWXAH.png">
<style>
th { border: 2.5px solid black; text-align: center }
td { border: 2.5px solid black; text-align: center }
tr { background-color: #ffffff }
#Rashmash { border: 2.5px solid black; border-collapse: collapse; margin-right: 40px; font-size: 0.6em; position: relative; width: 840px; height: 375.36px }
#Toranut { border: 2.5px solid black; border-collapse: collapse; float: left; margin-left: 40px; font-size: 0.6em; position: relative; width: 840px; height: 375.36px }
.Rtimestamp { text-align: center; font-weight: bold }
.Ttimestamp { text-align: center; font-weight: bold; color: #ffffff; background-color: #6aa84f }
#RcopyArea { outline: 1.5px solid black; width: 300px; height: 200px; overflow: hidden; resize: none }
#TcopyArea { outline: 1.5px solid black; width: 300px; height: 200px; overflow: hidden; resize: none }
.copyContainer { float: left; margin-left: 50px; position: relative }

.hanichText { cursor: pointer }
.hanichText:hover { text-decoration: line-through }
</style>
</head>

<body dir="rtl" style="font-size: 1.5em; font-family: arial; background-image: url('background.png')">
<h1 style="text-align: center">ברוך הבא לרשמ"שומט!</h1>
<br>
<img src="https://i.imgur.com/wvNWXAH.png" style="display: block; margin-left: auto; margin-right: auto; position: relative; bottom: 40px"></img>
<br>
<div style="position: relative; bottom: 280px">
<div id="RcopyAreaContainer" class="copyContainer" style="display: none"><h3 style="text-align: center">רשמ"ש</h3><textarea id="RcopyArea" readonly></textarea></div>
<div id="TcopyAreaContainer" class="copyContainer" style="display: none"><h3 style="text-align: center">תורנות</h3><textarea id="TcopyArea" readonly></textarea></div>
הכנס את רשימת השמירות של השבוע הקודם: 
<input type="file" id="oldRashmash">
<br>
הכנס קובץ של מערכת שעות השמירה: 
<input type="file" id="guardSchedule">
<br>
הכנס קובץ של מערכת התורנויות (לא חובה): 
<input type="file" id="dutySchedule">
<br><br>
הכנס קובץ מיפוי שנה א':
<input type="file" id="grade1Table">
<br>
הכנס קובץ מיפוי שנה ב':
<input type="file" id="grade2Table">
<br>
הכנס קובץ מיפוי שנה ג':
<input type="file" id="grade3Table">
<br><br>
<button id="button" style="font-size: 1.2em">אשר</button>
<br>
<div style="float: left; font-size: 0.8em; position: fixed; bottom: 15px; left: 15px">לשאלות פנו לאיילת רן<br>054-468-4628<br><br>כל הזכויות שמורות לאלון רן</div>
<table id="Rashmash" border=1 style="display: none">
<tr id="Rrow0"><th></th><th>ראשון</th><th>שני</th><th>שלישי</th><th>רביעי</th><th>חמישי</th><th>שישי</th></tr>
<tr id="Rrow1"><td class="Rtimestamp" style="background-color: #d9d9d9">00:00-02:00</td></tr>
<tr id="Rrow2"><td class="Rtimestamp">02:00-04:00</td></tr>
<tr id="Rrow3"><td class="Rtimestamp" style="background-color: #d9d9d9">04:00-06:00</td></tr>
<tr id="Rrow4"><td class="Rtimestamp">06:00-08:00</td></tr>
<tr id="Rrow5"><td class="Rtimestamp" style="background-color: #d9d9d9">08:00-10:00</td></tr>
<tr id="Rrow6"><td class="Rtimestamp">10:00-12:00</td></tr>
<tr id="Rrow7"><td class="Rtimestamp" style="background-color: #d9d9d9">12:00-14:00</td></tr>
<tr id="Rrow8"><td class="Rtimestamp">14:00-16:00</td></tr>
<tr id="Rrow9"><td class="Rtimestamp" style="background-color: #d9d9d9">16:00-18:00</td></tr>
<tr id="Rrow10"><td class="Rtimestamp">18:00-20:00</td></tr>
<tr id="Rrow11"><td class="Rtimestamp" style="background-color: #d9d9d9">20:00-22:00</td></tr>
<tr id="Rrow12"><td class="Rtimestamp">22:00-00:00</td></tr>
<tr id="Rrow13"><td class="Rtimestamp" style="background-color: #d9d9d9">כונן יום</td></tr>
<tr id="Rrow14"><td class="Rtimestamp">כונן לילה</td></tr>
<tr id="Rrow15"><td class="Rtimestamp" style="background-color: #d9d9d9">קצינת"ו</td></tr>
</table>

<table id="Toranut" border=1 style="display: none">
<tr id="Trow0"><th></th><th>ראשון</th><th>שני</th><th>שלישי</th><th>רביעי</th><th>חמישי</th><th>שישי</th></tr>
<tr id="Trow1"><td class="Ttimestamp">משיכת ארוחת בוקר 7:45 בבריטניה</td></tr>
<tr id="Trow2"><td class="Ttimestamp">תורנות החזרת כלים לאפי (יום שלישי עד שעה 12:00)</td></tr>
<tr id="Trow3"><td class="Ttimestamp">משיכת ארוחת ערב 17:45 בבריטניה</td></tr>
<tr id="Trow4"><td class="Ttimestamp">שטיפת כלים  <font color="red">וסורקים</font> 23:30 בטרקלין</td></tr>
<tr id="Trow5"><td class="Ttimestamp">חופיות לטירה (קלקר בלבד) 22:00</td></tr>
<tr id="Trow6"><td class="Ttimestamp">תורנות טירה</td></tr>
<tr id="Trow7"><td class="Ttimestamp">מילוי המקרר + הארון בטרקלין 23:00</td></tr>
</table>
</div>

<script>
function Hanich(fullName, grade, department, arabist, kamat, hasKeptNight, hoursUnable, hoursAble, justicePointsR, justicePointsT)
{
	this.fullName = fullName;
	this.grade = grade;
	this.department = department;
	this.arabist = arabist;
	this.kamat = kamat;
	this.hasKept = false;
	this.hasServed = false;
	this.hasKeptNight = hasKeptNight;
	this.hoursUnable = hoursUnable;
	this.hoursAble = hoursAble;
	this.justicePointsR = justicePointsR;
	this.justicePointsT = justicePointsT;
	this.isKeepingOn = [];
	
	this.print = function() {
		returnValue = "Name: " + fullName + "\n";
		returnValue += "Grade: " + grade + "\n";
		returnValue += "Department: " + department + "\n";
		returnValue += "Arabist: " + arabist + "\n";
		returnValue += "Kamat: " + kamat + "\n";
		returnValue += "Hours unavailable: " + hoursUnable + "\n";
		returnValue += "Hours available: " + hoursAble + "\n";
		returnValue += "Justice points of Rashmash: " + justicePointsR;
		returnValue += "Justice points of Toranut: " + justicePointsT;
		
		return returnValue;
	}
}

function gradeWeek(sun, mon, tue, wed, thu)
{
	this.schedules = [sun, mon, tue, wed, thu];
}

var gradeWeek3 = new gradeWeek(
	[[], ["math", "econ"], ["arab"], [], ["math", "comp", "philo"], []],
	[["econ", "comp", "philo"], ["econ", "comp"], [], [], [], []],
	[[], [], ["math", "econ", "comp"], ["econ", "comp"], [], ["kamat"]],
	[["philo", "math"], ["math"], ["econ", "math"], ["math", "comp", "econ"], [], ["philo", "math", "comp", "econ"]],
	[["math", "econ"], [], ["math", "comp", "philo"], [], [], []]
);
var gradeWeek2 = new gradeWeek(
	[[], [], ["arab"], ["comp", "econ"], [], []],
	[[], [], ["math", "econ"], [], ["philo"], ["philo", "comp"]],
	[[], [], [], ["math", "philo", "comp"], ["math", "philo", "comp"], []],
	[[], ["econ"], ["philo"], ["econ", "comp"], ["comp"], ["philo", "math", "comp", "econ"]],
	[["math", "econ", "comp"], ["econ"], ["math", "philo", "comp"], ["comp", "philo", "econ"], [], []]
);
var gradeWeek1 = new gradeWeek(
	[[], ["arab"], [], ["math", "econ"], [], ["math", "philo"]],
	[["philo"], ["philo"], ["math", "econ"], ["comp"], [], []],
	[["math", "philo", "econ"], ["philo"], [], ["math", "philo"], [], []],
	[[], [], [], ["math"], [], ["philo", "math", "comp", "econ"]],
	[["econ"], ["math", "econ", "philo"], [], ["philo", "math", "comp", "econ"], ["philo", "math", "comp", "econ"], ["philo", "math", "comp", "econ"]]
);



function grade(week, hanichList)
{
	this.week = week;
	this.hanichList = hanichList;
}

grade3 = new grade(gradeWeek3, []);
grade2 = new grade(gradeWeek2, []);
grade1 = new grade(gradeWeek1, []);





Rashmash = [[],[],[],[],[],[]];
Toranut = [[],[],[],[],[],[]];

createToranut = false;

var oldRashmashText;
var guardText;
var dutyText;
var grade1Text;
var grade2Text;
var grade3Text;

function readBlob(callback) {

	var oldRashmashFiles = document.getElementById("oldRashmash").files;
	var guardFiles = document.getElementById("guardSchedule").files;
	var dutyFiles = document.getElementById("dutySchedule").files;
	var grade1Files = document.getElementById("grade1Table").files;
	var grade2Files = document.getElementById("grade2Table").files;
	var grade3Files = document.getElementById("grade3Table").files;
	if (!(oldRashmashFiles.length && guardFiles.length && grade1Files.length && grade2Files.length && grade3Files.length))
	{
		alert("אנא הכנס את כל הקבצים");
		return;
	}
	
	var oldRashmashFile = oldRashmashFiles[0];
	var guardFile = guardFiles[0];
	var dutyFile;
	var grade1File = grade1Files[0];
	var grade2File = grade2Files[0];
	var grade3File = grade3Files[0];
	
	if(dutyFiles.length)
	{
		createToranut = true;
		dutyFile = dutyFiles[0];
	}
	
	
	var reader = new FileReader();
	
	
	var iLoaded = 0;

	reader.onloadend = function(evt) {
		if (evt.target.readyState == FileReader.DONE) {
			iLoaded++;
			
			switch(iLoaded) {
			case 1:
				oldRashmashText = evt.target.result;
				reader.readAsText(guardFile);
				break;
			case 2:
				guardText = evt.target.result;
				reader.readAsText(grade1File);
				break;
			case 3:
				grade1Text = evt.target.result;
				reader.readAsText(grade2File);
				break;
			case 4:
				grade2Text = evt.target.result;
				reader.readAsText(grade3File);
				break;
			case 5:
				grade3Text = evt.target.result;
				if(createToranut) reader.readAsText(dutyFile);
				else callback(oldRashmashText, guardText, null, grade1Text, grade2Text, grade3Text);
				break;
			case 6:
				dutyText = evt.target.result;
				callback(oldRashmashText, guardText, dutyText, grade1Text, grade2Text, grade3Text);
			}
		}
	};

	reader.readAsText(oldRashmashFile);
}

document.getElementById("button").addEventListener('click', function(event) {
	if (event.target.tagName.toLowerCase() == 'button') {
		readBlob(analyze);
	}
}, false);

document.getElementById("RcopyArea").addEventListener("click", function() {
	this.select();
	document.execCommand("copy");
}, false);

document.getElementById("TcopyArea").addEventListener("click", function() {
	this.select();
	document.execCommand("copy");
}, false);


hours = [];
days = [];

oldNightHours = [];

function cells()
{
	this.cells = [];
}


sortingToranut = false;

grade1HanichList = [];
grade2HanichList = [];
grade3HanichList = [];

disabledTimeslots = [];

function analyze(oldRashmashText, guardText, dutyText, grade1Text, grade2Text, grade3Text)
{
	disabledTimeslots = [];
	// Guard table
	
	guardText = guardText.replace(/ג/g, "3").replace(/ב/g, "2").replace(/א/g, "1");
	
	days = [new cells(), new cells(), new cells(), new cells(), new cells(), new cells()];
	
	lines = guardText.split("\n");

	
	for(lineCounter = 0; lineCounter < 15; lineCounter++)
	{
		line = lines[lineCounter + 2];
		hours[lineCounter] = new cells();
		hours[lineCounter].cells = line.split(",");
		hours[lineCounter].cells.splice(0, 4);	
		for(j = 0; j < 6; j++)
			days[j].cells[lineCounter] = hours[lineCounter].cells[j];
	}
	
	
	
	// Old Rashmash
	
	lines = oldRashmashText.split("\n");
	
	for(lineCounter = 1; lineCounter <= 2; lineCounter++)
	{
		oldKeeps = lines[lineCounter + 2].split(",");
		oldKeeps.splice(0, 4);
		oldKeeps.splice(6, 2);
		oldNightHours = oldNightHours.concat(oldKeeps);
	}
	
	
	
	if(createToranut)
	{
		// Duty table
		
		dutyText = dutyText.replace(/ג/g, "3").replace(/ב/g, "2").replace(/א/g, "1");
		
		dutyDays = [new cells(), new cells(), new cells(), new cells(), new cells(), new cells()];
		
		lines = dutyText.split("\n");

		
		for(lineCounter = 0; lineCounter < 7; lineCounter++)
		{
			line = lines[lineCounter + 7];
			hours[lineCounter] = new cells();
			hours[lineCounter].cells = line.split(",");
			hours[lineCounter].cells.splice(0, 4);	
			for(j = 0; j < 6; j++)
				dutyDays[j].cells[lineCounter] = hours[lineCounter].cells[j];
		}
	}
	
	
	
	// Grade tables
	
	grade1HanichList = [];
	hanichLineList = grade1Text.split("\n");
	for(i = 0; i < hanichLineList.length; i++)
	{
		hanichInfo = hanichLineList[i].split(",");
		if(hanichInfo.length > 5) {
			fullName = hanichInfo[0];
			department = hanichInfo[1];
			arabist = (hanichInfo[2] == 1);
			hasKeptNight = oldNightHours.includes(fullName);
			hoursUnable = hanichInfo[4].split(" ");
			hoursAble = hanichInfo[5].split(" ");
			justicePointsR = parseFloat(hanichInfo[6]);
			justicePointsT = parseFloat(hanichInfo[7]);
			
			grade1HanichList[i] = new Hanich(fullName, 1, department, arabist, false, hasKeptNight, hoursUnable, hoursAble, justicePointsR, justicePointsT);
		}
	}
	grade1.hanichList = grade1HanichList;
	
	
	grade2HanichList = [];
	hanichLineList = grade2Text.split("\n");
	for(i = 0; i < hanichLineList.length; i++)
	{
		hanichInfo = hanichLineList[i].split(",");
		if(hanichInfo.length > 5) {
			fullName = hanichInfo[0];
			department = hanichInfo[1];
			arabist = (hanichInfo[2] == 1);
			hasKeptNight = oldNightHours.includes(fullName);
			hoursUnable = hanichInfo[4].split(" ");
			hoursAble = hanichInfo[5].split(" ");
			justicePointsR = parseFloat(hanichInfo[6]);
			justicePointsT = parseFloat(hanichInfo[7]);
			
			grade2HanichList[i] = new Hanich(fullName, 2, department, arabist, false, hasKeptNight, hoursUnable, hoursAble, justicePointsR, justicePointsT);
		}
	}
	grade2.hanichList = grade2HanichList;
	
	
	grade3HanichList = [];
	hanichLineList = grade3Text.split("\n");
	hanichLineList.splice(3,1);
	for(i = 0; i < hanichLineList.length; i++)
	{
		hanichInfo = hanichLineList[i].split(",");
		if(hanichInfo.length > 5) {
			fullName = hanichInfo[0];
			department = hanichInfo[1];
			arabist = (hanichInfo[2] == 1);
			kamat = (hanichInfo[3] == 1);
			hasKeptNight = oldNightHours.includes(fullName);
			hoursUnable = hanichInfo[4].split(" ");
			hoursAble = hanichInfo[5].split(" ");
			justicePointsR = parseFloat(hanichInfo[6]);
			justicePointsT = parseFloat(hanichInfo[7]);
			
			grade3HanichList[i] = new Hanich(fullName, 3, department, arabist, kamat, hasKeptNight, hoursUnable, hoursAble, justicePointsR, justicePointsT);
		}
	}
	grade3.hanichList = grade3HanichList;
	
	
	
	startSorting();
}

function resetHanich(hanich)
{
	hanich.hasKept = false;
	hanich.hasServed = false;
	hanich.hasKeptNight = false;
	hanich.isKeepingOn = [];
}

function startSorting()
{
	for(i = 0; i < grade1.hanichList.length; i++)
		resetHanich(grade1.hanichList[i]);
	
	for(i = 0; i < grade2.hanichList.length; i++)
		resetHanich(grade2.hanichList[i]);
	
	for(i = 0; i < grade3.hanichList.length; i++)
		resetHanich(grade3.hanichList[i]);
	
	
	error = false;
	sortingToranut = false;
	sortHanichsR();
	if(createToranut)
	{
		sortingToranut = true;
		sortHanichsT();
	}
	
	if(!error) showResults();
}


hanichCells = [];

var interval;

function showResults()
{
	for(i = 0; i < hanichCells.length; i++)
	{
		cell = hanichCells[i];
		cell.parentNode.removeChild(cell);
	}
	hanichCells = [];
	
	RcopyText = "";
	TcopyText = "";
	
	for(y = 0; y < 15; y++)
	{
		for(x = 0; x < 6; x++)
		{
			cell = document.createElement("td");
			hanichCells.push(cell);
			hanich = Rashmash[x][y];
			color = "#ffffff";
			if(hanich != null) {
				hanichName = document.createElement("span");
				hanichName.innerHTML = hanich.fullName;
				hanichName.className = "hanichText";
				hanichName.hanich = hanich;
				hanichName.day = x;
				hanichName.index = y;
				hanichName.toranut = false;
				hanichName.addEventListener("click", disableTimeslot);
				cell.appendChild(hanichName);
				
				switch(hanich.grade)
				{
				case 1:
					color = "#ffff99";
					break;
				case 2:
					color = "#8eaadb";
					break;
				case 3:
					color = "#c55a11";
					break;
				}
				RcopyText += hanich.fullName;
			}
			else
				cell.innerHTML = "	";
			cell.style = "background-color: " + color;
			row = document.getElementById("Rrow" + (y + 1));
			row.appendChild(cell);
			
			if(x != 5)	RcopyText += "	";
		}
		if(y != 14)	RcopyText += "&#13;&#10;";
	}
	document.getElementById("RcopyArea").innerHTML = RcopyText;
	
	if(createToranut) {
		for(y = 0; y < 7; y++)
		{
			for(x = 0; x < 6; x++)
			{
				cell = document.createElement("td");
				hanichCells.push(cell);
				hanichs = Toranut[x][y];
				color = "#ffffff";
				if(hanichs != null) {
					firstHanich = document.createElement("span");
					firstHanich.innerHTML = hanichs[0].fullName;
					firstHanich.className = "hanichText";
					firstHanich.hanich = hanichs[0];
					firstHanich.day = x;
					firstHanich.index = y;
					firstHanich.toranut = true;
					firstHanich.addEventListener("click", disableTimeslot);
					cell.appendChild(firstHanich);
					if(hanichs.length != 1)
					{
						cell.appendChild(document.createTextNode(" ו"));
						secondHanich = document.createElement("span");
						secondHanich.innerHTML = hanichs[1].fullName;
						secondHanich.className = "hanichText";
						secondHanich.hanich = hanichs[1];
						secondHanich.day = x;
						secondHanich.index = y;
						secondHanich.toranut = true;
						secondHanich.addEventListener("click", disableTimeslot);
						cell.appendChild(secondHanich);
					}
					
					switch(hanichs[0].grade)
					{
					case 1:
						color = "#ffff99";
						break;
					case 2:
						color = "#8eaadb";
						break;
					case 3:
						color = "#c55a11";
						break;
					}
					TcopyText += (hanichs.length == 1) ? hanichs[0].fullName : hanichs[0].fullName + " ו" + hanichs[1].fullName;
				}
				else
					cell.innerHTML = "	";
				cell.style = "background-color: " + color;
				row = document.getElementById("Trow" + (y + 1));
				row.appendChild(cell);
				
				if(x != 5)	TcopyText += "	";
			}
			if(y != 14)	TcopyText += "&#13;&#10;";
		}
		document.getElementById("TcopyArea").innerHTML = TcopyText;
	}
	
	clearInterval(interval);
	interval = setInterval(rTableAnimation, 1);
}

rAnimateI = 0;
tAnimateI = 0;

function rTableAnimation()
{
	rAnimateI++;
	rAnimateProg = rAnimateI / 150;
	if(rAnimateProg > 1) rAnimateProg = 1;
	rAnimate = (650 - (rAnimateProg * rAnimateProg * (3 - 2 * rAnimateProg)) * 650);
	
	document.getElementById("Rashmash").style = "top: " + (rAnimate + 20) + "px";
	rCopyAnimation();
	if(createToranut)	tTableAnimation();
}

function tTableAnimation()
{
	tAnimateI++;
	tAnimateProg = tAnimateI / 150;
	if(tAnimateProg > 1) tAnimateProg = 1;
	tAnimate = (650 - (tAnimateProg * tAnimateProg * (3 - 2 * tAnimateProg)) * 650);
	document.getElementById("Toranut").style = "top: " + (tAnimate - 355.36) + "px";
	tCopyAnimation();
}

function rCopyAnimation()
{
	rAnimateProg = rAnimateI / 100;
	if(rAnimateProg > 1) rAnimateProg = 1;
	rAnimate = (300 - (rAnimateProg * rAnimateProg * (3 - 2 * rAnimateProg)) * 300) + 50;
	
	document.getElementById("RcopyAreaContainer").style = "bottom: " + rAnimate + "px";
	if(createToranut)	document.getElementById("TcopyAreaContainer").style = "bottom: " + rAnimate + "px";
}

function tCopyAnimation()
{
	tAnimateProg = tAnimateI / 100;
	if(tAnimateProg > 1) tAnimateProg = 1;
	tAnimate = (300 - (tAnimateProg * tAnimateProg * (3 - 2 * tAnimateProg)) * 300) + 50;
	
	document.getElementById("TcopyAreaContainer").style = "bottom: " + tAnimate + "px";
}







function timeslot(hanichName, day, index, toranut)
{
	this.hanichName = hanichName;
	this.day = day;
	this.index = index;
	this.toranut = toranut;
}


function disableTimeslot()
{
	disabledTimeslots.push(new timeslot(this.hanich.fullName, this.day, this.index, this.toranut));
	startSorting();
}





function sortHanichsR()
{
	earlyHours(1);
	earlyHours(2);
	earlyHours(0);
	earlyHours(3);
	
	for(day = 0; day < 6; day++) {
		assignHanichR(day, 4);
		for(hour = 5; hour < 15; hour++)
			assignHanichR(day, hour);
	}
}

function sortHanichsT()
{
	for(day = 0; day < 6; day++) {
		assignHanichT(day, 3, 0);
		
		assignHanichT(day, 5, 1)
		
		assignHanichT(day, 8, 2);
		assignHanichT(day, 11, 3);
		assignHanichT(day, 11, 4);
		assignHanichT(day, -1, 5);
		assignHanichT(day, 11, 6);
	}
}


function setKeeper(hanich, day, hour)
{
	Rashmash[day][hour] = hanich;
	if(hanich != null)
	{
		hanich.hasKept = true;
		hanich.isKeepingOn[day] = hour;
	}
}

function setServers(hanichs, day, index)
{
	Toranut[day][index] = hanichs;
	if(hanichs != null) {
		for(o = 0; o < hanichs.length; o++)
			hanichs[o].hasServed = true;
	}
}



function assignHanichR(day, hour)
{
	hanichList = getGradeHanichsR(day, hour);
	hanichList = removeUnable(hanichList, day, hour, false, hour);
	hanichList = removeBusy(hanichList, day, hour);
	setKeeper(getMinimumJusticeR(hanichList), day, hour);
}

function assignHanichT(day, hour, index)
{
	hanichList = getGradeHanichsT(day, index);
	if(hour != -1) {
		hanichList = removeUnable(hanichList, day, hour, true, index);
		hanichList = removeBusy(hanichList, day, hour);
		if(index == 1)	hanichList = removeNotBusy(hanichList, day, hour + 1);
		newHanichList = [];
		for(i = 0; i < hanichList.length; i++)
		{
			hanich = hanichList[i];
			if((!hanich.hasKept || hanich.isKeepingOn[day] != hour) && !hanich.hasServed)	newHanichList.push(hanich);
		}
		hanichList = newHanichList;
	}
	setServers(getMinimumJusticeT(hanichList, (index <= 4) ? 2 : 1), day, index);
}



function earlyHours(hour)
{
	for(day = 0; day < 6; day++) {
		gradeHanichs = getGradeHanichsR(day, hour);
		newGradeHanichs = [];
		for(i = 0; i < gradeHanichs.length; i++)
		{
			hanich = gradeHanichs[i];
			if(!(hanich.hasKeptNight && (hour >= 1 && hour <= 2)))
				newGradeHanichs.push(hanich);
		}
			
		selected = getMinimumJusticeR(newGradeHanichs);
		setKeeper(selected, day, hour);
	}
}



function getGradeHanichsR(day, hour)
{
	gradeNumber = days[day].cells[hour];
	
	var hanichList = [];
	
	switch(parseInt(gradeNumber))
	{
	case 1:
		hanichList = grade1.hanichList;
		break;
	case 2:
		hanichList = grade2.hanichList;
		break;
	case 3:
		hanichList = grade3.hanichList;
		break;
	}
	
	return hanichList;
}

function getGradeHanichsT(day, hour)
{
	gradeNumber = dutyDays[day].cells[hour];
	
	var hanichList = [];
	
	switch(parseInt(gradeNumber))
	{
	case 1:
		hanichList = grade1.hanichList;
		break;
	case 2:
		hanichList = grade2.hanichList;
		break;
	case 3:
		hanichList = grade3.hanichList;
		break;
	}
	
	return hanichList;
}


function getMinimumJusticeR(hanichs)
{
	if(hanichs.length == 0) return null;
	var minimum = hanichs[0].justicePointsR;
	var keeper = hanichs[0];

	for(i = 0; i < hanichs.length; i++)
	{
		minimum = hanichs[i].justicePointsR;
		keeper = hanichs[i];
		
		if(!hanichs[i].hasKept)
			break;
	}

	for(i = 0; i < hanichs.length; i++)
	{
		if(hanichs[i].justicePointsR < minimum && !hanichs[i].hasKept)
		{
			minimum = hanichs[i].justicePointsR;
			keeper = hanichs[i];
		}
	}

	return keeper;
}


function getMinimumJusticeT(hanichs, number)
{
	if(hanichs.length == 0) return null;
	var minimum = hanichs[0].justicePointsT;
	var servers = [hanichs[0]];
	
	for(f = 0; f < number; f++)
	{
		for(i = 0; i < hanichs.length; i++)
		{
			minimum = hanichs[i].justicePointsT;
			servers[f] = hanichs[i];
			
			if(!hanichs[i].hasServed)
				break;
		}

		for(i = 0; i < hanichs.length; i++)
		{
			if(hanichs[i].justicePointsT < minimum && !hanichs[i].hasServed)
			{
				minimum = hanichs[i].justicePointsT;
				servers[f] = hanichs[i];
			}
		}
		
		servers[f].hasServed = true;
	}
	
	return servers;
}


function removeUnable(hanichs, day, hour, toranut, index)
{
	var hanichsLeft = [];
	for(i = 0; i < hanichs.length; i++)
	{
		hanich = hanichs[i];
		unables = hanich.hoursUnable;
		var remove = false;
		for(j = 0; j < unables.length; j++)
		{
			unable = unables[j];
			dayUnable = translateDay(unable.substring(0, 3));
			hourUnable = parseInt(unable.substring(3,5)) / 2;
			if(dayUnable == day && hourUnable == hour) { remove = true; break; }
		}
		
		for(j = 0; j < disabledTimeslots.length; j++)
		{
			disabledTimeslot = disabledTimeslots[j];
			if(disabledTimeslot.day == day && disabledTimeslot.index == index && disabledTimeslot.toranut == toranut && disabledTimeslot.hanichName == hanich.fullName) { remove = true; break; }
		}
		
		if(!remove) hanichsLeft.push(hanich);
	}
	return hanichsLeft;
}


function checkIfAble(hanich, day, hour)
{
	ables = hanich.hoursAble;
	isAble = false;
	for(i = 0; i < ables.length; i++)
	{
		able = ables[i];
		dayAble = translateDay(unable.substring(0, 3));
		hourAble = parseInt(unable.substring(3,5)) / 2;
		if(dayAble == day && hourAble == hour) { isAble = true; break; }
	}
	return isAble;
}


function removeBusy(hanichs, day, hour)
{
	var nonBusy = [];
	var hanichsLeft = [];
	
	if(day == 5 || hour > 9 || hour < 4 || hanichs.length == 0)
		return hanichs;
	else
	{
		switch(hanichs[0].grade)
		{
		case 1:
			nonBusy = gradeWeek1.schedules[day][hour - 4];
			break;
		case 2:
			nonBusy = gradeWeek2.schedules[day][hour - 4];
			break;
		case 3:
			nonBusy = gradeWeek3.schedules[day][hour - 4];
			break;
		}
	}
	if(nonBusy.length == 0)	{ alert("Error: Incorrect grade on " + detranslateDay(day) + ", " + detranslateHour(hour) + ", for " + ((sortingToranut) ? "Toranut" : "Rashmash")); error = true; }
	
	for(k = 0; k < hanichs.length; k++)
	{
		hanich = hanichs[k];
		if(nonBusy.includes(hanich.department) || (hanich.arabist && nonBusy.includes("arab")) || (hanich.kamat && nonBusy.includes("kamat")) || checkIfAble(hanich, day, hour))
			hanichsLeft.push(hanich);
	}
	
	return hanichsLeft;
	
}


function removeNotBusy(hanichs, day, hour)
{
	var nonBusy = [];
	var hanichsLeft = [];
	
	if(day == 5 || hour > 9 || hour < 4 || hanichs.length == 0)
		return hanichs;
	else
	{
		switch(hanichs[0].grade)
		{
		case 1:
			nonBusy = gradeWeek1.schedules[day][hour - 4];
			break;
		case 2:
			nonBusy = gradeWeek2.schedules[day][hour - 4];
			break;
		case 3:
			nonBusy = gradeWeek3.schedules[day][hour - 4];
			break;
		}
	}
	
	for(k = 0; k < hanichs.length; k++)
	{
		hanich = hanichs[k];
		if(!(nonBusy.includes(hanich.department) || (hanich.arabist && nonBusy.includes("arab")) || (hanich.kamat && nonBusy.includes("kamat")) || checkIfAble(hanich, day, hour)))
			hanichsLeft.push(hanich);
	}
	
	return hanichsLeft;
	
}



function translateDay(day)
{
	switch(day)
	{
	case "sun":	return 0;
	case "mon":	return 1;
	case "tue":	return 2;
	case "wed":	return 3;
	case "thu":	return 4;
	case "fri":	return 5;
	default:	return 0;
	}
}

function detranslateDay(day)
{
	switch(day)
	{
	case 0:		return "Sunday";
	case 1:		return "Monday";
	case 2:		return "Tuesday";
	case 3:		return "Wednesday";
	case 4:		return "Thursday";
	case 5:		return "Friday";
	default:	return "";
	}
}

function detranslateHour(hour)
{
	switch(hour)
	{
	case 0:		return "00:00-02:00";
	case 1:		return "02:00-04:00";
	case 2:		return "04:00-06:00";
	case 3:		return "06:00-08:00";
	case 4:		return "08:00-10:00";
	case 5:		return "10:00-12:00";
	case 6:		return "12:00-14:00";
	case 7:		return "14:00-16:00";
	case 8:		return "16:00-18:00";
	case 9:		return "18:00-20:00";
	case 10:	return "20:00-22:00";
	case 11:	return "22:00-00:00";
	case 12:	return "כונן יום";
	case 13:	return "כונן לילה";
	case 14:	return "קצינת\"ו";
	}
}

</script>

</body>
